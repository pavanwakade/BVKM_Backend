services:
  bvkm_backend:
    image: bvkm_backend:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bvkm_backend
    dns:
      - 1.1.1.1  # Cloudflare DNS - better IPv6 support than Google DNS
      - 8.8.8.8
    # NOTE: Docker on Windows (WSL2) has limited IPv6 routing to external endpoints.
    # Using alternative DNS helps with resolution, but IPv6-only endpoints may still be unreachable.
    # BEST SOLUTION: Deploy to Render (cloud) for full IPv6 support. See DEPLOY_TO_RENDER.md
    environment:
      # Use SSL when connecting to Supabase. If certificate verification causes issues,
      # you can replace sslmode=require with sslmode=require&sslfactory=org.postgresql.ssl.NonValidatingFactory
      SPRING_DATASOURCE_URL: "jdbc:postgresql://db.ldxukptpjddrtzcvvcpm.supabase.co:5432/postgres?sslmode=require"
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: BVKM_PMS
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SERVER_PORT: 8080
      # Prevent HikariCP from failing fast on startup when DB is temporarily unreachable
      SPRING_DATASOURCE_HIKARI_INITIALIZATION_FAIL_TIMEOUT: -1
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
